---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-roxctl-scan
spec:
  description: |
    Verifies that the task scans the image and produces TEST_OUTPUT, SCAN_OUTPUT, IMAGES_PROCESSED and REPORTS results.
  tasks:
    - name: run-roxctl-scan
      taskRef:
        name: roxctl-scan
      params:
        - name: image-url
          value: "quay.io/konflux-ci/konflux-test:v1.4.44"
        - name: image-digest
          value: "sha256:00d5ba3ac4fadb315da2199e931c1167f2b45884d2990de39104dfa9b78117d4"
        - name: skip-upload
          value: "true"
        - name: mock
          value: "true"
        - name: rox_image
          value: "registry.access.redhat.com/ubi9/ubi-minimal:latest"
    - name: check-results
      runAfter:
        - run-roxctl-scan
      params:
        - name: TEST_OUTPUT
          value: $(tasks.run-roxctl-scan.results.TEST_OUTPUT)
        - name: SCAN_OUTPUT
          value: $(tasks.run-roxctl-scan.results.SCAN_OUTPUT)
        - name: IMAGES_PROCESSED
          value: $(tasks.run-roxctl-scan.results.IMAGES_PROCESSED)
        - name: REPORTS
          value: $(tasks.run-roxctl-scan.results.REPORTS)
      taskSpec:
        params:
          - name: TEST_OUTPUT
          - name: SCAN_OUTPUT
          - name: IMAGES_PROCESSED
          - name: REPORTS
        steps:
          - name: verify-outputs
            image: quay.io/konflux-ci/konflux-test:v1.4.44@sha256:00d5ba3ac4fadb315da2199e931c1167f2b45884d2990de39104dfa9b78117d4
            env:
              - name: TEST_OUTPUT
                value: $(params.TEST_OUTPUT)
              - name: SCAN_OUTPUT
                value: $(params.SCAN_OUTPUT)
              - name: IMAGES_PROCESSED
                value: $(params.IMAGES_PROCESSED)
              - name: REPORTS
                value: $(params.REPORTS)
            script: |
              #!/bin/bash
              set -euo pipefail

              # Verifying TEST_OUTPUT
              echo "$TEST_OUTPUT" | jq .
              RESULT=$(echo "$TEST_OUTPUT" | jq -r '.result')
              if [[ "$RESULT" == "SUCCESS" || "$RESULT" == "WARNING" ]]; then
                 echo "TEST_OUTPUT check passed. Result: $RESULT"
              else
                 echo "TEST_OUTPUT check failed. Result: $RESULT"
                 exit 1
              fi

              # Verifying SCAN_OUTPUT"
              echo "$SCAN_OUTPUT" | jq .
              # In mock mode, we expect valid JSON structure.
              if echo "$SCAN_OUTPUT" | jq -e '.vulnerabilities != null' > /dev/null; then
                 echo "SCAN_OUTPUT check passed."
              else
                 echo "SCAN_OUTPUT check failed. 'vulnerabilities' missing."
                 exit 1
              fi

              #  Accept real or mocked data
              if echo "$SCAN_OUTPUT" | jq -e '.vulnerabilities != null' > /dev/null; then
                 echo "SCAN_OUTPUT check passed (Real Data)."
              elif echo "$SCAN_OUTPUT" | jq -e '.result == "mocked_scan_pass"' > /dev/null; then
                 echo "SCAN_OUTPUT check passed (Mock Data)."
              else
                 echo "SCAN_OUTPUT check failed."
                 exit 1
              fi

              # Verifying IMAGES_PROCESSED
              echo "$IMAGES_PROCESSED" | jq .
              if echo "$IMAGES_PROCESSED" | jq -e '.image.pullspec != null' > /dev/null; then
                 echo "IMAGES_PROCESSED check passed."
              else
                 echo "IMAGES_PROCESSED check failed. 'image.pullspec' missing."
                 exit 1
              fi

              #Verifying REPORTS
              echo "$REPORTS" | jq .
              if echo "$REPORTS" | jq -e 'type == "object"' > /dev/null; then
                 echo "REPORTS check passed."
              else
                 echo "REPORTS check failed. Not a valid JSON object."
                 exit 1
              fi

              echo "ALL TESTS PASSED"
